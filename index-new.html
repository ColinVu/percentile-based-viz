<!DOCTYPE html>
<html>
<head>
  <title>Development Indicators - Percentile Scroll</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/scrollama/3.2.0/scrollama.min.js"></script>
  
</head>
<body>
  <div class="loading">Loading data...</div>

  <div class="cors-info" id="cors-info" style="display: none;">
    <div class="cors-message">
      <h3>⚠️ File Access Restriction</h3>
      <p>The browser is blocking access to the Excel files due to CORS policy when opening the HTML file directly.</p>
      <p><strong>Solutions:</strong></p>
      <ol>
        <li><strong>Run a local server</strong> (recommended):
          <ul>
            <li>Python: <code>python -m http.server 8000</code></li>
            <li>Node.js: <code>npx serve .</code></li>
            <li>PHP: <code>php -S localhost:8000</code></li>
          </ul>
          Then visit <code>http://localhost:8000</code>
        </li>
        <li><strong>Use the fallback sample data</strong> (current): The app will work with representative sample data</li>
        <li><strong>Upload custom files</strong>: The file upload feature still works for custom datasets</li>
      </ol>
      <button onclick="document.getElementById('cors-info').style.display='none'">Got it, continue with sample data</button>
    </div>
  </div>

  <div class="header">
    <div class="control-bar">
      <div class="dataset-selector">
        <div class="dataset-options">
          <label class="dataset-option">
            <input type="radio" name="dataset" value="us-counties" checked>
            <span>US County Indicators</span>
          </label>
          <label class="dataset-option">
            <input type="radio" name="dataset" value="country-development">
            <span>Country Development Indicators</span>
          </label>
          <label class="dataset-option">
            <input type="radio" name="dataset" value="custom">
            <span>Custom Dataset</span>
            <div class="custom-upload" id="custom-upload" style="display: none;">
              <label for="file-input" class="file-upload">Upload</label>
        <input type="file" id="file-input" accept=".xlsx,.xls">
        <span class="file-name" id="file-name">No file selected</span>
            </div>
          </label>
        </div>
      </div>
      <h1 id="app-title">Percentile Scroll</h1>
      <select id="countrySelect">
        <option value="">Select an area...</option>
      </select>
    </div>
    <div class="toggle-view">
      <div class="toggle-view-label">
        Select view:
      </div>
      <select class="toggle-view-select" id="toggle-view">
        <option value="percentile" selected>Percentile Scroll</option>
        <option value="identifier">Location Identifier View</option>
        <option value="category">Category Slider View</option>
        <option value="category-v2">Category Slider V2</option>
        <option value="category-v3">Category Slider V3</option>
        <option value="box">Box and Whisker</option>
      </select>
    </div>

  </div>
  
  <div class="percentile-scroll-container" id="percentile-scroll-container">
    <div class="scroll-section" id="scroll-section">
      <!-- Percentile steps will be generated here -->
    </div>
    
    <div class="visualization-section">
      <div class="country-info">
        <div class="country-name" id="country-name">Select an area</div>
        <div class="percentile-display" id="percentile-display">50%</div>
      </div>
      <div class="metric-cards" id="metric-cards">
        <div class="no-metrics">Please select a country</div>
      </div>
      <!-- <div class="scroll-indicator">
        <div>Scroll on the left to explore percentiles</div>
        <div class="scroll-icon">↕</div> -->
      </div>
    </div>
  </div>

  <div class="country-identifier-container hidden" id="country-identifier-container">
    <div class="identifier-layout">
      <div class="indicator-list" id="indicator-list"></div>
      <div class="beeswarm-panel">
        <svg id="beeswarm-svg"></svg>
        <div class="tooltip hidden" id="beeswarm-tooltip"></div>
        <div class="hover-label hidden" id="beeswarm-hover-label"></div>
      </div>
    </div>
  </div>

  <!-- Include SheetJS library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <!-- Load modular view components -->
  <script src="views/shared.js"></script>
  <script src="views/data-loader.js"></script>
  <script src="views/percentile-scroll.js"></script>
  <script src="views/location-identifier.js"></script>
  <script src="views/beeswarm-category.js"></script>
  <script src="views/category-slider.js"></script>
  <script src="views/category-slider-v2.js"></script>
  <script src="views/beeswarm-category-v3.js"></script>
  <script src="views/category-slider-v3.js"></script>
  <script src="views/box-plot.js"></script>
  <script src="views/box-whisker.js"></script>

  <script>
    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
      // Create percentile steps
      window.createPercentileSteps();
      
      // Setup event listeners
      setupEventListeners();
      
      // Initialize scrollama
      window.initScrollama();
      
      // Load the default dataset (US Counties)
      window.loadSelectedDataset();
    });
    
    // Set up event listeners
    function setupEventListeners() {
      // Dataset selection change event
      document.querySelectorAll('input[name="dataset"]').forEach(radio => {
        radio.addEventListener('change', function() {
          const customUpload = document.getElementById('custom-upload');
          if (this.value === 'custom') {
            customUpload.style.display = 'flex';
          } else {
            customUpload.style.display = 'none';
            // Clear file input if switching away from custom
            const fileInput = document.getElementById('file-input');
            const fileName = document.getElementById('file-name');
            fileInput.value = '';
            fileName.textContent = 'No file selected';
            // Load the selected dataset
            window.loadSelectedDataset();
          }
        });
      });
      
      // File input change event
      document.getElementById('file-input').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        document.getElementById('file-name').textContent = file.name;
        
        // Show loading indicator
        document.querySelector('.loading').style.display = 'flex';
        
        // Read the file
        const reader = new FileReader();
        
        reader.onload = function(e) {
          try {
            // Parse the Excel file using a client-side library like SheetJS
            if (typeof XLSX !== 'undefined') {
              const data = new Uint8Array(e.target.result);
              const workbook = XLSX.read(data, { type: 'array' });
              
              // Get the first sheet
              const firstSheetName = workbook.SheetNames[0];
              const worksheet = workbook.Sheets[firstSheetName];
              
              // Convert to JSON
              window.appState.jsonData = XLSX.utils.sheet_to_json(worksheet);
              
              window.processData();
            } else {
              // If XLSX library is not available, use the example data
              alert('XLSX library not loaded. Using example data instead.');
            }
          } catch (error) {
            console.error('Error parsing Excel file:', error);
            alert('Error parsing Excel file. Using example data instead.');
          }
          
          // Hide loading indicator
          document.querySelector('.loading').style.display = 'none';
        };
        
        reader.onerror = function() {
          console.error('Error reading file');
          alert('Error reading file. Using example data instead.');
          document.querySelector('.loading').style.display = 'none';
        };
        
        reader.readAsArrayBuffer(file);
      });
      
      // Country/County selection change event
      document.getElementById('countrySelect').addEventListener('change', function() {
        window.appState.selectedCountry = this.value;
        if (window.appState.selectedCountry) {
          window.calculatePercentiles(window.appState.selectedCountry);
          window.updateCountryInfo();
          
          // Get current step or default to 50
          const activeStep = document.querySelector('.step.is-active');
          const percentile = activeStep ? 
            parseInt(activeStep.getAttribute('data-step')) : 50;
          
          window.updateMetricsDisplay(percentile);

          // If in identifier/category view, refresh lists and active chart
          const activeMetricBtn = document.querySelector('.indicator-list .indicator-item.active');
          if (window.appState.viewMode === 'identifier') {
            window.renderIdentifierMetricList();
            const firstMetricBtn = document.querySelector('.indicator-list .indicator-item');
            if (firstMetricBtn && firstMetricBtn.dataset && firstMetricBtn.dataset.metricKey) {
              window.renderBeeswarm(firstMetricBtn.dataset.metricKey);
              firstMetricBtn.classList.add('active');
            }
          } else if (window.appState.viewMode === 'category') {
            window.renderCategoryMetricList();
            const firstMetricBtn = document.querySelector('.indicator-list .indicator-item');
            if (firstMetricBtn && firstMetricBtn.dataset && firstMetricBtn.dataset.metricKey) {
              window.renderBeeswarmCategory(firstMetricBtn.dataset.metricKey);
              firstMetricBtn.classList.add('active');
            }
          } else if (window.appState.viewMode === 'category-v2') {
            window.renderCategoryMetricListV2();
            const firstMetricBtn = document.querySelector('.indicator-list .indicator-item');
            if (firstMetricBtn && firstMetricBtn.dataset && firstMetricBtn.dataset.metricKey) {
              window.renderBeeswarmCategory(firstMetricBtn.dataset.metricKey);
              firstMetricBtn.classList.add('active');
            }
          } else if (window.appState.viewMode === 'category-v3') {
            window.renderCategoryMetricListV3();
            const firstMetricBtn = document.querySelector('.indicator-list .indicator-item');
            if (firstMetricBtn && firstMetricBtn.dataset && firstMetricBtn.dataset.metricKey) {
              window.renderBeeswarmCategoryV3(firstMetricBtn.dataset.metricKey);
              firstMetricBtn.classList.add('active');
            }
          } else if (window.appState.viewMode === 'box') {
            window.renderCategoryMetricListBox();
            const firstMetricBtn = document.querySelector('.indicator-list .indicator-item');
            if (firstMetricBtn && firstMetricBtn.dataset && firstMetricBtn.dataset.metricKey) {
              window.renderBoxPlotCategory(firstMetricBtn.dataset.metricKey);
              firstMetricBtn.classList.add('active');
            }
          }
        } else {
          // No selection, reset display
          document.getElementById('country-name').textContent = window.appState.geoMode === 'country' ? 'Select a country' : 'Select a county';
          document.getElementById('metric-cards').innerHTML = 
            (window.appState.geoMode === 'country' 
              ? '<div class="no-metrics">Please select a country to view metrics</div>'
              : '<div class="no-metrics">Please select a county to view metrics</div>');
        }
      });

      // View toggle event
      const viewToggle = document.getElementById('toggle-view');
      if (viewToggle) {
        viewToggle.addEventListener('change', function() {
          const pctContainer = document.getElementById('percentile-scroll-container');
          const idContainer = document.getElementById('country-identifier-container');
          window.appState.viewMode = this.value;
          if (this.value === 'identifier') {
            pctContainer.classList.add('hidden');
            idContainer.classList.remove('hidden');
            document.getElementById('app-title').textContent = 'Location Identifier View';
            window.renderIdentifierMetricList();
            const firstMetricBtn = document.querySelector('.indicator-list .indicator-item');
            if (firstMetricBtn && firstMetricBtn.dataset && firstMetricBtn.dataset.metricKey) {
              window.renderBeeswarm(firstMetricBtn.dataset.metricKey);
              firstMetricBtn.classList.add('active');
            }
          } else if (this.value === 'category') {
            pctContainer.classList.add('hidden');
            idContainer.classList.remove('hidden');
            document.getElementById('app-title').textContent = 'Category Slider View';
            window.renderCategoryMetricList();
            const firstMetricBtn = document.querySelector('.indicator-list .indicator-item');
            if (firstMetricBtn && firstMetricBtn.dataset && firstMetricBtn.dataset.metricKey) {
              window.renderBeeswarmCategory(firstMetricBtn.dataset.metricKey);
              firstMetricBtn.classList.add('active');
            }
          } else if (this.value === 'category-v2') {
            pctContainer.classList.add('hidden');
            idContainer.classList.remove('hidden');
            document.getElementById('app-title').textContent = 'Category Slider V2';
            window.renderCategoryMetricListV2();
            const firstMetricBtn = document.querySelector('.indicator-list .indicator-item');
            if (firstMetricBtn && firstMetricBtn.dataset && firstMetricBtn.dataset.metricKey) {
              window.renderBeeswarmCategory(firstMetricBtn.dataset.metricKey);
              firstMetricBtn.classList.add('active');
            }
          } else if (this.value === 'category-v3') {
            pctContainer.classList.add('hidden');
            idContainer.classList.remove('hidden');
            document.getElementById('app-title').textContent = 'Category Slider V3';
            window.renderCategoryMetricListV3();
            const firstMetricBtn = document.querySelector('.indicator-list .indicator-item');
            if (firstMetricBtn && firstMetricBtn.dataset && firstMetricBtn.dataset.metricKey) {
              window.renderBeeswarmCategoryV3(firstMetricBtn.dataset.metricKey);
              firstMetricBtn.classList.add('active');
            }
        } else if (this.value === 'box') {
          pctContainer.classList.add('hidden');
          idContainer.classList.remove('hidden');
          document.getElementById('app-title').textContent = 'Box and Whisker View';
          window.renderCategoryMetricListBox();
          const firstMetricBtn = document.querySelector('.indicator-list .indicator-item');
          if (firstMetricBtn && firstMetricBtn.dataset && firstMetricBtn.dataset.metricKey) {
            window.renderBoxPlotCategory(firstMetricBtn.dataset.metricKey);
              firstMetricBtn.classList.add('active');
            }
          } else {
            idContainer.classList.add('hidden');
            pctContainer.classList.remove('hidden');
            document.getElementById('app-title').textContent = 'Percentile Scroll';
            if (window.appState.scroller && typeof window.appState.scroller.resize === 'function') {
              window.appState.scroller.resize();
            }
          }
        });
      }
    }
  </script>
</body>
</html>

