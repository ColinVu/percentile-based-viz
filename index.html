<!DOCTYPE html>
<html>
<head>
  <title>Factxis</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/scrollama/3.2.0/scrollama.min.js"></script>
  
</head>
<body>
  <div class="loading">Loading data...</div>

  <div class="cors-info" id="cors-info" style="display: none;">
    <div class="cors-message">
      <h3>⚠️ File Access Restriction</h3>
      <p>The browser is blocking access to the Excel files due to CORS policy when opening the HTML file directly.</p>
      <p><strong>Solutions:</strong></p>
      <ol>
        <li><strong>Run a local server</strong> (recommended):
          <ul>
            <li>Python: <code>python -m http.server 8000</code></li>
            <li>Node.js: <code>npx serve .</code></li>
            <li>PHP: <code>php -S localhost:8000</code></li>
          </ul>
          Then visit <code>http://localhost:8000</code>
        </li>
        <li><strong>Use the fallback sample data</strong> (current): The app will work with representative sample data</li>
        <li><strong>Upload custom files</strong>: The file upload feature still works for custom datasets</li>
      </ol>
      <button onclick="document.getElementById('cors-info').style.display='none'">Got it, continue with sample data</button>
    </div>
  </div>

  <!-- Sidebar Toggle Button -->
  <button class="sidebar-toggle" id="sidebar-toggle">
    <span class="arrow"><</span>
  </button>

  <!-- Collapsible Sidebar -->
  <div class="sidebar open" id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-tabs">
        <button class="sidebar-tab active" data-tab="controls" type="button">Controls</button>
        <button class="sidebar-tab" data-tab="outlier-data" type="button">Outlier Data</button>
        <button class="sidebar-tab" data-tab="h-index" type="button">H-index</button>
        <button class="sidebar-tab" data-tab="summation" type="button">Summation</button>      </div>
    </div>
    
    <div class="sidebar-content">
      <div class="tab-panel active" id="controls-tab-panel">
      <div class="control-section" style="display: none;">
        <h3>View Mode</h3>
        <select class="toggle-view-select" id="toggle-view">
          <option value="percentile">Percentile Scroll</option>
          <option value="identifier">Horizontal View</option>
          <option value="category">Category Slider (Distributed)</option>
          <option value="category-v2">Category Slider (Color ramp)</option>
          <option value="category-v3">Category Slider (Country Detailed)</option>
          <option value="category-v6">Category Slider (Encoded Data)</option>
          <option value="category-final" selected>Factxis</option>
          <option value="category-v7">Category Slider (Multi-Select)</option>
          <option value="category-v8">Filter Select</option>
          <option value="category-v4">Category Slider (County Detailed)</option>
          <option value="category-v5">Category Slider (Comparison)</option>
          <option value="box">Box and Whisker</option>
        </select>
      </div>

      <div class="control-section" id="filter-select-section" style="display: none;">
        <h3 class="collapsible-header" id="filter-section-header">
          <span>Filter Data</span>
          <span class="collapse-arrow">&#9660;</span>
        </h3>
        <div class="collapsible-content" id="filter-section-content">
          <div class="filter-select-info" id="filter-select-info">Add filters to narrow the dataset.</div>
          <div class="filter-select-list" id="filter-select-filters"></div>
          <button id="filter-select-add" class="filter-select-add-btn" type="button">Add Filter</button>
        </div>
      </div>

      <div class="control-section" id="encoding-mode-section" style="display: none;">
        <h3>Data Encoding</h3>
        <div class="encoding-mode-options">
          <label class="encoding-mode-option">
            <input type="radio" name="encodingMode" value="selection" checked>
            <span>Color by Selection</span>
          </label>
          <label class="encoding-mode-option">
            <input type="radio" name="encodingMode" value="feature">
            <span>Color by Feature</span>
          </label>
        </div>
      </div>

      <div class="control-section" id="selection-table-section" style="display: none;">
        <h3>Selected Locations</h3>
        <div class="selection-table-container" id="selection-table-container">
          <div class="selection-table" id="selection-table"></div>
          <div class="selection-table-controls">
            <span class="selection-table-count-label">Records found: <span id="selection-table-count">0</span></span>
            <button class="selection-table-add-btn" id="selection-table-add" title="Add location">+</button>
          </div>
        </div>
      </div>

      <div class="control-section" id="location-section">
        <h3>Location</h3>
        <div style="display: flex; align-items: center; gap: 8px;">
          <input type="radio" id="selectMainLocation" name="activeLocation" value="main" style="display: none;">
          <select id="countrySelect" style="flex: 1;">
            <option value="">Select an area...</option>
          </select>
        </div>
      </div>

      <div class="control-section" id="multi-select-section" style="display: none;">
        <h3>Selected Areas</h3>
        <div class="multi-selection-box" id="multi-selection-box">
          <div class="multi-selection-title">Primary + Secondary</div>
          <div class="multi-selection-list" id="multi-selection-list"></div>
        </div>
      </div>

      <div class="control-section" id="encoded-color-section" style="display: none;">
        <h3>Color Encoding</h3>
        <select id="encodedColorSelect">
          <option value="">Categorical column not available</option>
        </select>
      </div>

      <div class="control-section" id="text-encoding-section" style="display: none;">
        <h3>Text Encoding</h3>
        <select id="textEncodingSelect">
          <option value="">None</option>
        </select>
      </div>

      <div class="control-section" id="comparison-location-section" style="display: none;">
        <h3>Comparison Location</h3>
        <div style="display: flex; align-items: center; gap: 8px;">
          <input type="radio" id="selectComparisonLocation" name="activeLocation" value="comparison">
          <select id="comparisonCountrySelect" style="flex: 1;">
            <option value="">Select an area to compare...</option>
          </select>
        </div>
      </div>

      <div class="control-section" id="state-section" style="display: none;">
        <h3>State</h3>
        <select id="stateSelect">
          <option value="">Select a state...</option>
        </select>
      </div>

      <div class="control-section" id="county-section" style="display: none;">
        <h3>County</h3>
        <select id="countySelect">
          <option value="">Select a county...</option>
        </select>
      </div>
      </div>

      <div class="tab-panel" id="outlier-data-tab-panel">
        <div id="outlier-data-content" class="outlier-data-container"></div>
      </div>

      <div class="tab-panel" id="h-index-tab-panel">
        <div id="h-index-content" class="h-index-container"></div>
      </div>

      <div class="tab-panel" id="summation-tab-panel">
        <div id="summation-content" class="summation-container"></div>
      </div>

    </div>
  </div>

  <!-- Main Header -->
  <div class="header">
    <div class="header-left">
      <label for="dataset-select" class="header-dataset-label">Dataset</label>
      <div class="header-dataset">
        <select id="dataset-select">
          <option value="country-development" selected>Country Development Indicators</option>
          <option value="us-counties">US County Indicators</option>
          <option value="colleges">Colleges</option>
          <option value="custom">Custom Dataset</option>
        </select>
        <div class="custom-upload" id="custom-upload" style="display: none;">
          <label for="file-input" class="file-upload">Upload</label>
          <input type="file" id="file-input" accept=".xlsx,.xls">
          <span class="file-name" id="file-name">No file selected</span>
        </div>
      </div>
    </div>
    <div class="header-center">
      <div class="header-title">
        <h1 id="app-title">Factxis</h1>
        <h2>Visualizing Datasets by Percentiles</h2>
      </div>
    </div>
    <div class="header-right">
    </div>
  </div>
  
  <div class="percentile-scroll-container" id="percentile-scroll-container">
    <div class="scroll-section" id="scroll-section">
      <!-- Percentile steps will be generated here -->
    </div>
    
    <div class="visualization-section">
      <div class="country-info">
        <div class="country-name" id="country-name">Select an area</div>
        <div class="percentile-display" id="percentile-display">50%</div>
      </div>
      <div class="metric-cards" id="metric-cards">
        <div class="no-metrics">Please select a country</div>
      </div>
      <!-- <div class="scroll-indicator">
        <div>Scroll on the left to explore percentiles</div>
        <div class="scroll-icon">↕</div> -->
      </div>
    </div>
  </div>

  <div class="country-identifier-container hidden" id="country-identifier-container">
    <div class="identifier-layout">
      <div class="indicator-list" id="indicator-list"></div>
      <div class="beeswarm-panel">
        <svg id="beeswarm-svg"></svg>
        <div class="tooltip hidden" id="beeswarm-tooltip"></div>
        <div class="hover-label hidden" id="beeswarm-hover-label"></div>
        
        <!-- Map Panel Popup (resizable) -->
        <div id="map-panel-popup" class="map-popup" style="display: none;">
          <div class="map-popup-header" id="map-popup-header">
            <button class="map-popup-close" id="map-popup-close">×</button>
          </div>
          <div class="map-popup-content">
            <svg id="map-svg" width="380" height="300"></svg>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Column Selection Dialog -->
  <div id="column-selection-dialog" class="modal-overlay" style="display: none;">
    <div class="modal-dialog">
      <div class="modal-header">
        <h3>Select data column to visualize</h3>
      </div>
      <div class="modal-body">
        <div class="column-list" id="column-selection-list"></div>
      </div>
      <div class="modal-footer">
        <button id="column-selection-cancel" class="modal-btn modal-btn-cancel">Cancel</button>
        <button id="column-selection-ok" class="modal-btn modal-btn-ok">OK</button>
      </div>
    </div>
  </div>

  <!-- Include SheetJS library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <!-- Load SimilarityIndex for finding similar records -->
  <script src="SimilarityIndex.js"></script>
  
  <!-- Load modular view components -->
  <script src="views/shared.js"></script>
  <script src="views/data-loader.js"></script>
  <script src="views/percentile-scroll.js"></script>
  <script src="views/location-identifier.js"></script>
  <script src="views/beeswarm-category.js"></script>
  <script src="views/category-slider.js"></script>
  <script src="views/category-slider-v2.js"></script>
  <script src="views/beeswarm-category-v3.js"></script>
  <script src="views/category-slider-v3.js"></script>
  <script src="views/beeswarm-category-encoded.js"></script>
  <script src="views/category-slider-v6.js"></script>
  <script src="views/beeswarm-category-final.js"></script>
  <script src="views/category-slider-final.js"></script>
  <script src="views/h-index.js"></script>
  <script src="views/summation.js"></script>
  <script src="views/outlier-data.js"></script>
  <script src="views/map-panel.js"></script>
  <script src="views/beeswarm-category-multiselect.js"></script>
  <script src="views/category-slider-v7.js"></script>
  <script src="views/beeswarm-category-filter.js"></script>
  <script src="views/category-slider-v8.js"></script>
  <script src="views/category-slider-v4.js"></script>
  <script src="views/category-slider-v5.js"></script>
  <script src="views/box-plot.js"></script>
  <script src="views/box-whisker.js"></script>

  <script>
    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
      console.log('[INIT] DOMContentLoaded fired');
      
      // Set initial sidebar state (starts open)
      document.body.classList.add('sidebar-open');
      
      // Set initial view mode state (default is category-final / Faxis mode)
      // OLD CODE (for percentile mode - commented out since we default to Faxis now):
      /*
      const locationSection = document.getElementById('location-section');
      const stateSection = document.getElementById('state-section');
      const countySection = document.getElementById('county-section');
      locationSection.style.display = 'block';
      stateSection.style.display = 'none';
      countySection.style.display = 'none';
      window.createPercentileSteps();
      window.initScrollama();
      */
      
      console.log('[INIT] Current viewMode:', window.appState.viewMode);
      
      // Setup event listeners
      setupEventListeners();
      
      // Initialize for category-final mode (Faxis)
      const pctContainer = document.getElementById('percentile-scroll-container');
      const idContainer = document.getElementById('country-identifier-container');
      console.log('[INIT] Containers found:', { pctContainer: !!pctContainer, idContainer: !!idContainer });
      
      if (pctContainer) pctContainer.classList.add('hidden');
      if (idContainer) idContainer.classList.remove('hidden');
      
      // App title is hard-coded as "Factxis" in HTML
      console.log('[INIT] App title is hard-coded as Factxis');
      
      // Show encoding mode section for category-final
      const encodingModeSection = document.getElementById('encoding-mode-section');
      console.log('[INIT] Encoding mode section found:', !!encodingModeSection);
      
      if (encodingModeSection) {
        encodingModeSection.style.display = 'block';
        // Initialize encoding mode
        const currentMode = window.appState.encodingMode || 'selection';
        console.log('[INIT] Setting encoding mode to:', currentMode);
        const checkedRadio = document.querySelector(`input[name="encodingMode"][value="${currentMode}"]`);
        if (checkedRadio) checkedRadio.checked = true;
        if (typeof updateEncodingMode === 'function') {
          updateEncodingMode(currentMode);
        }
      }
      
      // Show filter select section for category-final (needs to be done after setupEventListeners)
      const filterSelectSection = document.getElementById('filter-select-section');
      if (filterSelectSection) {
        console.log('[INIT] Showing filter-select section');
        filterSelectSection.style.display = 'block';
      }
      
      // Load the default dataset (US Counties)
      console.log('[INIT] Loading default dataset...');
      window.loadSelectedDataset();
    });
    
    // Function to populate state dropdown from dataset
    function populateStateDropdown() {
      const stateSelect = document.getElementById('stateSelect');
      const countySelect = document.getElementById('countySelect');
      
      // Clear existing options
      stateSelect.innerHTML = '<option value="">Select a state...</option>';
      countySelect.innerHTML = '<option value="">Select a county...</option>';
      
      if (!window.appState.jsonData || window.appState.jsonData.length === 0) {
        return;
      }
      
      // Get unique states from the dataset
      const states = [...new Set(window.appState.jsonData
        .map(d => d.State)
        .filter(state => state && state.trim() !== '')
      )].sort();
      
      // Populate state dropdown
      states.forEach(state => {
        const option = document.createElement('option');
        option.value = state;
        option.textContent = state;
        stateSelect.appendChild(option);
      });
      
      // Auto-select first state if available
      if (states.length > 0) {
        stateSelect.value = states[0];
        // Populate counties for the first state
        populateCountyDropdown(states[0]);
      }
    }
    
    // Function to populate county dropdown based on selected state
    function populateCountyDropdown(selectedState) {
      const countySelect = document.getElementById('countySelect');
      
      // Clear existing options
      countySelect.innerHTML = '<option value="">Select a county...</option>';
      
      if (!selectedState || !window.appState.jsonData || window.appState.jsonData.length === 0) {
        return;
      }
      
      // Get counties for the selected state
      const counties = window.appState.jsonData
        .filter(d => d.State === selectedState && d.County && d.County.trim() !== '')
        .map(d => d.County)
        .sort();
      
      // Populate county dropdown
      counties.forEach(county => {
        const option = document.createElement('option');
        option.value = county;
        option.textContent = county;
        countySelect.appendChild(option);
      });
      
      // Auto-select first county if available
      if (counties.length > 0) {
        countySelect.value = counties[0];
      }
    }
    
    // Function to populate comparison dropdown with same data as main dropdown
    function populateComparisonDropdown() {
      const countrySelect = document.getElementById('countrySelect');
      const comparisonSelect = document.getElementById('comparisonCountrySelect');
      
      if (!countrySelect || !comparisonSelect) return;
      
      // Clear existing options
      comparisonSelect.innerHTML = '<option value="">Select an area to compare...</option>';
      
      // Copy all options from main dropdown except the placeholder
      Array.from(countrySelect.options).forEach(option => {
        if (option.value !== '') {
          const newOption = document.createElement('option');
          newOption.value = option.value;
          newOption.textContent = option.textContent;
          comparisonSelect.appendChild(newOption);
        }
      });
      
      // Initialize comparison country in appState if not set
      if (!window.appState.comparisonCountry) {
        window.appState.comparisonCountry = '';
      }
    }
    
    // Function to render beeswarm for Category Slider (County Detailed) (filtered by state)
    function renderBeeswarmCategoryV4(metricKey) {
      const svg = d3.select('#beeswarm-svg');
      const container = document.querySelector('.beeswarm-panel');
      if (!svg.node() || !container) return;

      const width = (container.clientWidth - 20) || 800; // 20px padding adjustment
      const height = container.clientHeight || 400;
      svg.attr('width', width)
         .attr('height', height)
         .style('display', 'block');
      console.log('Beeswarm category v4 width:', width, 'container:', container.clientWidth);

      // Get selected state and county
      const selectedState = document.getElementById('stateSelect').value;
      const selectedCounty = document.getElementById('countySelect').value;
      
      if (!selectedState) {
        svg.selectAll('*').remove();
        window.appState.previousBeeswarmNodes = [];
        return;
      }

      // Filter data to selected state only
      const stateData = window.appState.jsonData.filter(d => d.State === selectedState);
      
      const values = stateData
        .map(d => {
          const raw = d[metricKey];
          const v = typeof raw === 'number' ? raw : parseFloat(raw);
          if (raw === '..' || raw === undefined || raw === null || isNaN(v)) return null;
          const label = d.County || 'Unknown County';
          return { label, value: v, county: d.County, state: d.State };
        })
        .filter(Boolean);

      if (values.length === 0) {
        svg.selectAll('*').remove();
        window.appState.previousBeeswarmNodes = [];
        return;
      }

      const sortedVals = values.map(v => v.value).slice().sort((a, b) => a - b);
      const withPct = values.map(d => {
        const smaller = sortedVals.filter(v => v < d.value).length;
        const equal = sortedVals.filter(v => v === d.value).length;
        const percentile = Math.round((smaller + 0.5 * equal) / sortedVals.length * 100);
        return { ...d, percentile };
      });

      const extent = d3.extent(sortedVals);
      const plotPaddingLeft = 50;
      const plotPaddingRight = 70;
      const plotPaddingTop = 40; // Increased to prevent tooltip cutoff
      const plotPaddingBottom = 40;
      const y = d3.scaleLinear().domain(extent).nice().range([height - plotPaddingBottom, plotPaddingTop]);
      const xCenter = (plotPaddingLeft + (width - plotPaddingRight)) / 2;

      // Store existing circles for transition
      const existingCircles = svg.selectAll('.beeswarm-points circle');
      const isFirstRender = existingCircles.empty();

      // Clear non-circle elements but keep circles for transition
      svg.selectAll('*:not(.beeswarm-points):not(.beeswarm-points circle)').remove();
      
      // Frame
      svg.append('rect')
        .attr('x', plotPaddingLeft)
        .attr('y', plotPaddingTop)
        .attr('width', (width - plotPaddingRight) - plotPaddingLeft)
        .attr('height', (height - plotPaddingBottom) - plotPaddingTop)
        .attr('fill', 'none')
        .attr('stroke', '#cbd5e1')
        .attr('stroke-width', 1);

      const isPercentMetric = /Pct|percent|Percent/.test(metricKey);
      const axis = d3.axisLeft(y).ticks(10).tickFormat(d => isPercentMetric ? `${Math.round(d)}%` : d);
      const axisG = svg.append('g').attr('transform', `translate(${plotPaddingLeft}, 0)`).call(axis);
      axisG.selectAll('text').style('font-size', '10px');

      // Horizontal guides at deciles
      for (let p = 10; p < 100; p += 10) {
        const qVal = d3.quantileSorted(sortedVals, p / 100);
        if (qVal != null) {
          const qy = y(qVal);
          svg.append('line')
            .attr('x1', plotPaddingLeft)
            .attr('x2', width - plotPaddingRight)
            .attr('y1', qy)
            .attr('y2', qy)
            .attr('stroke', '#e2e8f0')
            .attr('stroke-width', 1)
            .attr('pointer-events', 'none');
          // Right-side percentile labels every 10%
          svg.append('text')
            .attr('x', width - plotPaddingRight + 6)
            .attr('y', qy + 3)
            .attr('fill', '#475569')
            .attr('font-size', 10)
            .text(`${p}%`);
        }
      }

      // Also include 0% and 100% labels (and guides)
      const endpoints = [0, 100];
      endpoints.forEach(P => {
        const qVal = d3.quantileSorted(sortedVals, P / 100);
        if (qVal != null) {
          const qy = y(qVal);
          // optional guide line
          svg.append('line')
            .attr('x1', plotPaddingLeft)
            .attr('x2', width - plotPaddingRight)
            .attr('y1', qy)
            .attr('y2', qy)
            .attr('stroke', '#e2e8f0')
            .attr('stroke-width', 1)
            .attr('pointer-events', 'none');
          // label
          svg.append('text')
            .attr('x', width - plotPaddingRight + 6)
            .attr('y', qy + 3)
            .attr('fill', '#475569')
            .attr('font-size', 10)
            .text(`${P}%`);
        }
      });

      const nodes = withPct.map(d => ({
        x: xCenter,
        y: y(d.value),
        r: 4.5,
        data: d
      }));

      const simulation = d3.forceSimulation(nodes)
        .force('y', d3.forceY(d => y(d.data.value)).strength(1))
        .force('x', d3.forceX(xCenter).strength(0.05))
        .force('collide', d3.forceCollide(d => d.r + 1.2))
        .stop();

      for (let i = 0; i < 200; i++) simulation.tick();
      nodes.forEach(n => {
        n.x = Math.max(plotPaddingLeft, Math.min(width - plotPaddingRight, n.x));
        n.y = Math.max(plotPaddingTop, Math.min(height - plotPaddingBottom, n.y));
      });

      const tooltip = d3.select('#beeswarm-tooltip');

      // Create or update circles with smooth transitions
      let circleGroup = svg.select('.beeswarm-points');
      if (circleGroup.empty()) {
        circleGroup = svg.append('g').attr('class', 'beeswarm-points');
      }

      // Bind data to circles
      const circles = circleGroup.selectAll('circle')
        .data(nodes, d => d.data.label); // Use label as key for object constancy

      // Handle entering circles (new data points)
      const enteringCircles = circles.enter()
        .append('circle')
        .attr('cx', d => {
          // If we have previous positions for this label, start from there
          const prev = window.appState.previousBeeswarmNodes.find(p => p.data.label === d.data.label);
          return prev ? prev.x : d.x;
        })
        .attr('cy', d => {
          const prev = window.appState.previousBeeswarmNodes.find(p => p.data.label === d.data.label);
          return prev ? prev.y : d.y;
        })
        .attr('r', d => d.data.label === selectedCounty ? d.r + 1.5 : d.r)
        .attr('fill', d => (d.data.label === selectedCounty ? '#e74c3c' : '#9b59b6'))
        .attr('opacity', 0.85);

      // Handle exiting circles (data points that are no longer present)
      circles.exit().remove();

      // Merge entering and updating circles
      const allCircles = enteringCircles.merge(circles);

      // Animate to new positions
      allCircles.transition()
        .duration(600)
        .ease(d3.easeQuadOut)
        .attr('cx', d => Math.max(plotPaddingLeft, Math.min(width - plotPaddingRight, d.x)))
        .attr('cy', d => Math.max(plotPaddingTop, Math.min(height - plotPaddingBottom, d.y)))
        .attr('r', d => d.data.label === selectedCounty ? d.r + 1.5 : d.r)
        .attr('fill', d => (d.data.label === selectedCounty ? '#e74c3c' : '#9b59b6'));

      // Store current positions for next transition
      window.appState.previousBeeswarmNodes = nodes.map(n => ({ ...n }));

      // Add interaction handlers to all circles
      allCircles
        .on('mouseenter', function(evt, d) {
          const html = `${d.data.label}<br>Value: ${window.formatValue(d.data.value, metricKey)}<br>Percentile: ${d.data.percentile}%`;
          tooltip.html(html)
            .classed('hidden', false)
            .style('left', (evt.offsetX + 32) + 'px')
            .style('top', (evt.offsetY - 48) + 'px');
          d3.select(this)
            .attr('stroke', '#1f6fa5')
            .attr('stroke-width', 2)
            .attr('fill', d => (d.data.label === selectedCounty ? '#c0392b' : '#8e44ad'))
            .attr('r', d.r + 2.5);
        })
        .on('mousemove', function(evt) {
          tooltip
            .style('left', (evt.offsetX + 32) + 'px')
            .style('top', (evt.offsetY - 48) + 'px');
        })
        .on('click', function(evt, d) {
          // Click to select county in Category Slider (County Detailed)
          const newSelection = d.data.label;
          if (!newSelection) return;

          // Update county dropdown value
          const countySelect = document.getElementById('countySelect');
          if (countySelect) countySelect.value = newSelection;

          // Update selectedCountry to "County, State" and recompute percentiles
          if (selectedState && newSelection) {
            const display = `${newSelection}, ${selectedState}`;
            window.appState.selectedCountry = display;
            window.calculatePercentiles(window.appState.selectedCountry);
            window.updateCountryInfo();
          }

          // Refresh metric list and beeswarm for V4
          if (window.renderCategoryMetricListV4) {
            window.renderCategoryMetricListV4();
          }
          renderBeeswarmCategoryV4(metricKey);
        })
        .on('mouseleave', function() {
          tooltip.classed('hidden', true);
          d3.select(this)
            .attr('stroke', 'none')
            .attr('fill', d => (d.data.label === selectedCounty ? '#e74c3c' : '#9b59b6'))
            .attr('r', d => d.r);
        });

      // Hover horizontal line and percentile label
      const hoverLine = svg.append('line')
        .attr('class', 'hover-line')
        .attr('x1', plotPaddingLeft)
        .attr('x2', width - plotPaddingRight)
        .attr('stroke', '#9aa5b1')
        .attr('stroke-dasharray', '4 4')
        .style('display', 'none');

      const hoverLabel = document.getElementById('beeswarm-hover-label');

      svg
        .on('mouseenter', function() {
          hoverLine.style('display', null);
          hoverLabel.classList.remove('hidden');
          // Ensure no box styling even if CSS is cached
          hoverLabel.style.background = 'transparent';
          hoverLabel.style.border = 'none';
          hoverLabel.style.padding = '0';
          hoverLabel.style.borderRadius = '0';
          hoverLabel.style.fontWeight = 'normal';
        })
        .on('mousemove', function(evt) {
          const [, my] = d3.pointer(evt);
          const clampedY = Math.max(plotPaddingTop, Math.min(height - plotPaddingBottom, my));
          hoverLine.attr('y1', clampedY).attr('y2', clampedY);
          const hoveredValue = y.invert(clampedY);
          const smaller = sortedVals.filter(v => v < hoveredValue).length;
          const equal = sortedVals.filter(v => v === hoveredValue).length;
          const p = Math.round((smaller + 0.5 * equal) / sortedVals.length * 100);
          hoverLabel.textContent = `Percentile: ${p}%`;
          hoverLabel.style.left = '75px'; // Position on left side near y-axis
          hoverLabel.style.top = (clampedY - 6) + 'px';
        })
        .on('mouseleave', function() {
          hoverLine.style('display', 'none');
          hoverLabel.classList.add('hidden');
        });

      svg.append('text')
        .attr('x', plotPaddingLeft + 6)
        .attr('y', 18)
        .attr('fill', '#2c3e50')
        .attr('font-size', 14)
        .attr('font-weight', 'bold')
        .text(window.formatMetricName(metricKey));
    }
    
    // Make renderBeeswarmCategoryV4 available globally
    window.renderBeeswarmCategoryV4 = renderBeeswarmCategoryV4;
    
    // Set up event listeners
    function setupEventListeners() {
      // Sidebar toggle functionality
      const sidebarToggle = document.getElementById('sidebar-toggle');
      const sidebar = document.getElementById('sidebar');
      const arrow = sidebarToggle.querySelector('.arrow');
      const encodingModeSection = document.getElementById('encoding-mode-section');
      const locationSection = document.getElementById('location-section');
      const encodedSection = document.getElementById('encoded-color-section');
      const encodedSelect = document.getElementById('encodedColorSelect');
      const textEncodingSection = document.getElementById('text-encoding-section');
      const textEncodingSelect = document.getElementById('textEncodingSelect');
      const multiSelectSection = document.getElementById('multi-select-section');
      const filterSelectSection = document.getElementById('filter-select-section');
      const filterSelectAddBtn = document.getElementById('filter-select-add');
      
      function refreshEncodedColorDropdown() {
        if (!encodedSelect) return;
        
        // Get both nominal (categorical) and numeric columns
        const nominalCols = Array.isArray(window.appState.nominalColumns) && window.appState.nominalColumns.length > 0
          ? window.appState.nominalColumns
          : (typeof window.getNominalColumns === 'function' ? window.getNominalColumns() : []);
        
        const numericCols = typeof window.getNumericMetrics === 'function' ? window.getNumericMetrics() : [];
        
        // Filter out FIPS codes from numeric columns
        const filteredNumericCols = numericCols.filter(m => {
          const norm = (m || '').toString().toLowerCase().replace(/[^a-z0-9]/g, '');
          return norm !== 'fipscode';
        });
        
        encodedSelect.innerHTML = '';
        
        // Always add "None" option first
        const noneOption = document.createElement('option');
        noneOption.value = '';
        noneOption.textContent = 'None';
        encodedSelect.appendChild(noneOption);
        
        const hasColumns = (nominalCols && nominalCols.length > 0) || (filteredNumericCols && filteredNumericCols.length > 0);
        
        if (!hasColumns) {
          encodedSelect.disabled = false;
          return;
        }
        
        encodedSelect.disabled = false;
        
        // Add categorical columns with optgroup
        if (nominalCols && nominalCols.length > 0) {
          const categoricalGroup = document.createElement('optgroup');
          categoricalGroup.label = 'Categorical';
          nominalCols.forEach(col => {
            const option = document.createElement('option');
            option.value = col;
            option.textContent = window.formatMetricName ? window.formatMetricName(col) : col;
            categoricalGroup.appendChild(option);
          });
          encodedSelect.appendChild(categoricalGroup);
        }
        
        // Add numeric columns with optgroup
        if (filteredNumericCols && filteredNumericCols.length > 0) {
          const numericGroup = document.createElement('optgroup');
          numericGroup.label = 'Numeric (5 bins)';
          filteredNumericCols.forEach(col => {
            const option = document.createElement('option');
            option.value = col;
            option.textContent = window.formatMetricName ? window.formatMetricName(col) : col;
            numericGroup.appendChild(option);
          });
          encodedSelect.appendChild(numericGroup);
        }
        
        // Set to current value or default to empty (None)
        const allColumns = [...(nominalCols || []), ...(filteredNumericCols || [])];
        const targetValue = (window.appState.categoryEncodedField && allColumns.includes(window.appState.categoryEncodedField))
          ? window.appState.categoryEncodedField
          : '';
        encodedSelect.value = targetValue;
        window.appState.categoryEncodedField = targetValue;
      }
      
      function refreshTextEncodingDropdown() {
        if (!textEncodingSelect) return;
        // Get ALL columns from the dataset
        const columns = window.appState.jsonData && window.appState.jsonData.length > 0
          ? Object.keys(window.appState.jsonData[0])
          : [];
        
        textEncodingSelect.innerHTML = '';
        
        // Add "None" option first
        const noneOption = document.createElement('option');
        noneOption.value = '';
        noneOption.textContent = 'None';
        textEncodingSelect.appendChild(noneOption);
        
        if (columns.length > 0) {
          const fragment = document.createDocumentFragment();
          // Add all columns
          columns.forEach(col => {
            const option = document.createElement('option');
            option.value = col;
            option.textContent = window.formatMetricName ? window.formatMetricName(col) : col;
            fragment.appendChild(option);
          });
          textEncodingSelect.appendChild(fragment);
        }
        
        // Set to current value or default to empty (None)
        const targetValue = (window.appState.categoryTextEncodedField && columns.includes(window.appState.categoryTextEncodedField))
          ? window.appState.categoryTextEncodedField
          : '';
        textEncodingSelect.value = targetValue;
        window.appState.categoryTextEncodedField = targetValue;
      }
      
      function showMultiSelectSection(show) {
        if (!multiSelectSection) return;
        multiSelectSection.style.display = show ? 'block' : 'none';
        if (show && typeof window.multiSelectUpdateBox === 'function') {
          window.multiSelectUpdateBox();
        }
      }

      function showFilterSelectSection(show) {
        if (!filterSelectSection) return;
        filterSelectSection.style.display = show ? 'block' : 'none';
        if (show && typeof window.filterSelectRenderControls === 'function') {
          window.filterSelectRenderControls();
        }
      }
      
      // Collapsible filter section toggle
      const filterSectionHeader = document.getElementById('filter-section-header');
      const filterSectionContent = document.getElementById('filter-section-content');
      
      // Function to update the filter section height (called when filters are added/removed)
      function updateFilterSectionHeight() {
        if (filterSectionContent && !filterSectionHeader.classList.contains('collapsed')) {
          filterSectionContent.style.maxHeight = filterSectionContent.scrollHeight + 'px';
        }
      }
      window.updateFilterSectionHeight = updateFilterSectionHeight;
      
      if (filterSectionHeader && filterSectionContent) {
        // Start collapsed by default
        filterSectionHeader.classList.add('collapsed');
        filterSectionContent.classList.add('collapsed');
        
        filterSectionHeader.addEventListener('click', function() {
          const isCollapsed = filterSectionHeader.classList.contains('collapsed');
          if (isCollapsed) {
            filterSectionHeader.classList.remove('collapsed');
            filterSectionContent.classList.remove('collapsed');
            filterSectionContent.style.maxHeight = filterSectionContent.scrollHeight + 'px';
          } else {
            filterSectionHeader.classList.add('collapsed');
            filterSectionContent.classList.add('collapsed');
          }
        });
        
        // Observe changes to the filter list and auto-update height
        const filterListEl = document.getElementById('filter-select-filters');
        if (filterListEl) {
          const observer = new MutationObserver(function() {
            updateFilterSectionHeight();
          });
          observer.observe(filterListEl, { childList: true, subtree: true });
        }
      }
      
      // Selection table section
      const selectionTableSection = document.getElementById('selection-table-section');
      const selectionTableEl = document.getElementById('selection-table');
      const selectionTableAddBtn = document.getElementById('selection-table-add');
      
      // Default colors for selection mode
      const SELECTION_MODE_COLORS = [
        '#ef4444', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', 
        '#ec4899', '#06b6d4', '#84cc16', '#f97316', '#6366f1',
        '#14b8a6', '#eab308', '#a855f7', '#22c55e', '#0ea5e9'
      ];
      
      // Initialize selection mode state if not exists
      if (!window.appState.selectionModeLocations) {
        window.appState.selectionModeLocations = [];
      }
      if (window.appState.selectionModeActiveIndex === undefined) {
        window.appState.selectionModeActiveIndex = 0;
      }
      
      // Get the next available color
      function getNextSelectionColor() {
        const usedColors = window.appState.selectionModeLocations.map(loc => loc.color);
        for (const color of SELECTION_MODE_COLORS) {
          if (!usedColors.includes(color)) return color;
        }
        // If all colors used, return a random one
        return SELECTION_MODE_COLORS[Math.floor(Math.random() * SELECTION_MODE_COLORS.length)];
      }
      
      // Render the selection table
      function renderSelectionTable() {
        if (!selectionTableEl) return;
        selectionTableEl.innerHTML = '';
        
        const locations = window.appState.selectionModeLocations || [];
        
        // Update records count (total available in dropdown, excluding placeholder)
        const countEl = document.getElementById('selection-table-count');
        const countrySelect = document.getElementById('countrySelect');
        const dropdownOptions = countrySelect ? Array.from(countrySelect.options).filter(opt => opt.value !== '') : [];
        if (countEl) countEl.textContent = String(dropdownOptions.length);
        
        if (locations.length === 0) {
          const emptyMsg = document.createElement('div');
          emptyMsg.className = 'selection-table-empty';
          emptyMsg.textContent = 'No locations selected. Click + to add.';
          selectionTableEl.appendChild(emptyMsg);
          return;
        }
        
        // Get available options from the country select
        const options = countrySelect ? Array.from(countrySelect.options) : [];
        
        locations.forEach((loc, idx) => {
          const row = document.createElement('div');
          row.className = 'selection-table-row' + (idx === window.appState.selectionModeActiveIndex ? ' active' : '');
          row.dataset.index = idx;
          
          // Color box
          const colorBox = document.createElement('div');
          colorBox.className = 'selection-table-color';
          colorBox.style.backgroundColor = loc.color;
          colorBox.title = 'Right-click to change color';
          colorBox.addEventListener('contextmenu', function(evt) {
            evt.preventDefault();
            evt.stopPropagation();
            
            // Create a simple color input popup
            const existingInput = document.getElementById('selection-color-input');
            if (existingInput) existingInput.remove();
            
            const inputContainer = document.createElement('div');
            inputContainer.id = 'selection-color-input';
            inputContainer.style.cssText = `
              position: fixed;
              left: ${evt.clientX + 5}px;
              top: ${evt.clientY + 5}px;
              z-index: 10000;
              background: white;
              border: 1px solid #cbd5e1;
              border-radius: 4px;
              padding: 8px;
              box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            `;
            
            // Add "Color:" label
            const colorLabel = document.createElement('div');
            colorLabel.textContent = 'Color:';
            colorLabel.style.cssText = `
              font-size: 10px;
              color: #64748b;
              margin-bottom: 4px;
              font-weight: 500;
            `;
            
            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = '#FF0000';
            input.value = loc.color;
            input.style.cssText = `
              width: 80px;
              padding: 4px 8px;
              font-size: 12px;
              font-family: monospace;
              border: 1px solid #e2e8f0;
              border-radius: 3px;
              outline: none;
            `;
            
            inputContainer.appendChild(colorLabel);
            inputContainer.appendChild(input);
            document.body.appendChild(inputContainer);
            input.focus();
            input.select();
            
            input.addEventListener('keydown', function(e) {
              if (e.key === 'Enter') {
                const newColor = input.value.trim();
                if (typeof window.isValidHexColor === 'function' && window.isValidHexColor(newColor)) {
                  loc.color = newColor;
                  renderSelectionTable();
                  if (window.appState.categorySelectedMetricKey && typeof window.renderBeeswarmCategoryFinal === 'function') {
                    window.renderBeeswarmCategoryFinal(window.appState.categorySelectedMetricKey);
                  }
                }
                inputContainer.remove();
              } else if (e.key === 'Escape') {
                inputContainer.remove();
              }
            });
            
            input.addEventListener('blur', function() {
              setTimeout(() => {
                if (document.body.contains(inputContainer)) {
                  inputContainer.remove();
                }
              }, 100);
            });
          });
          
          // Dropdown
          const select = document.createElement('select');
          const defaultOpt = document.createElement('option');
          defaultOpt.value = '';
          defaultOpt.textContent = 'Select location...';
          select.appendChild(defaultOpt);
          options.forEach(opt => {
            if (opt.value) {
              const newOpt = document.createElement('option');
              newOpt.value = opt.value;
              newOpt.textContent = opt.textContent;
              select.appendChild(newOpt);
            }
          });
          // Set the dropdown value
          console.log('[SELECTION] Setting dropdown for row', idx, 'location:', loc.location);
          if (loc.location) {
            select.value = loc.location;
            console.log('[SELECTION] Dropdown value set to:', select.value);
          }
          select.addEventListener('change', function(evt) {
            evt.stopPropagation();
            loc.location = this.value;
            
            // Sync with main selectedCountry if this is the active row
            if (idx === window.appState.selectionModeActiveIndex && this.value) {
              window.appState.selectedCountry = this.value;
              if (countrySelect) countrySelect.value = this.value;
              window.calculatePercentiles(this.value);
              window.updateCountryInfo();
              if (typeof window.renderCategoryMetricListFinal === 'function') {
                window.renderCategoryMetricListFinal();
              }
            }
            
            if (window.appState.categorySelectedMetricKey && typeof window.renderBeeswarmCategoryFinal === 'function') {
              window.renderBeeswarmCategoryFinal(window.appState.categorySelectedMetricKey);
            }
          });
          select.addEventListener('click', function(evt) {
            evt.stopPropagation();
          });
          
          // Remove button
          const removeBtn = document.createElement('div');
          removeBtn.className = 'selection-table-remove';
          removeBtn.innerHTML = '&times;';  // Use HTML entity for ×
          removeBtn.title = 'Remove location';
          removeBtn.addEventListener('click', function(evt) {
            evt.stopPropagation();
            window.appState.selectionModeLocations.splice(idx, 1);
            
            // Adjust active index if needed
            if (window.appState.selectionModeActiveIndex >= window.appState.selectionModeLocations.length) {
              window.appState.selectionModeActiveIndex = Math.max(0, window.appState.selectionModeLocations.length - 1);
            }
            
            // If this was the first row and it's now removed, clear selection
            if (window.appState.selectionModeLocations.length === 0) {
              window.appState.selectedCountry = '';
              if (countrySelect) countrySelect.value = '';
            } else {
              // Update selection to the new active row
              const newActive = window.appState.selectionModeLocations[window.appState.selectionModeActiveIndex];
              if (newActive && newActive.location) {
                window.appState.selectedCountry = newActive.location;
                if (countrySelect) countrySelect.value = newActive.location;
              }
            }
            
            window.updateCountryInfo();
            renderSelectionTable();
            if (typeof window.renderCategoryMetricListFinal === 'function') {
              window.renderCategoryMetricListFinal();
            }
            if (window.appState.categorySelectedMetricKey && typeof window.renderBeeswarmCategoryFinal === 'function') {
              window.renderBeeswarmCategoryFinal(window.appState.categorySelectedMetricKey);
            }
          });
          
          // Row click to select
          row.addEventListener('click', function() {
            window.appState.selectionModeActiveIndex = idx;
            if (loc.location) {
              window.appState.selectedCountry = loc.location;
              if (countrySelect) countrySelect.value = loc.location;
              window.calculatePercentiles(loc.location);
              window.updateCountryInfo();
              if (typeof window.renderCategoryMetricListFinal === 'function') {
                window.renderCategoryMetricListFinal();
              }
            }
            renderSelectionTable();
            if (window.appState.categorySelectedMetricKey && typeof window.renderBeeswarmCategoryFinal === 'function') {
              window.renderBeeswarmCategoryFinal(window.appState.categorySelectedMetricKey);
            }
          });
          
          row.appendChild(colorBox);
          row.appendChild(select);
          row.appendChild(removeBtn);
          selectionTableEl.appendChild(row);
        });
      }
      
      // Add new location row
      function addSelectionRow(locationValue = '') {
        const color = getNextSelectionColor();
        console.log('[SELECTION] Adding row with location:', locationValue);
        window.appState.selectionModeLocations.push({
          location: locationValue,
          color: color
        });
        // Make the new row active
        window.appState.selectionModeActiveIndex = window.appState.selectionModeLocations.length - 1;
        renderSelectionTable();
      }
      
      // Initialize selection table from current selected country
      function initSelectionTableFromCurrent() {
        console.log('[SELECTION] initSelectionTableFromCurrent called, selectedCountry:', window.appState.selectedCountry, 'existing locations:', window.appState.selectionModeLocations.length);
        if (window.appState.selectionModeLocations.length === 0) {
          // No locations yet - add one
          if (window.appState.selectedCountry) {
            addSelectionRow(window.appState.selectedCountry);
          } else {
            addSelectionRow('');
          }
        } else if (window.appState.selectedCountry) {
          // Check if first location is empty and update it
          const firstLoc = window.appState.selectionModeLocations[0];
          if (firstLoc && !firstLoc.location) {
            console.log('[SELECTION] Updating empty first location to:', window.appState.selectedCountry);
            firstLoc.location = window.appState.selectedCountry;
            renderSelectionTable();
          }
        }
      }
      
      if (selectionTableAddBtn) {
        selectionTableAddBtn.addEventListener('click', function() {
          addSelectionRow('');
        });
      }
      
      window.renderSelectionTable = renderSelectionTable;
      window.addSelectionRow = addSelectionRow;
      window.initSelectionTableFromCurrent = initSelectionTableFromCurrent;
      
      function updateEncodingMode(mode) {
        if (!encodingModeSection) return;
        
        // Store the mode
        window.appState.encodingMode = mode;
        
        if (mode === 'selection') {
          // Show selection table, hide Location dropdown
          if (selectionTableSection) {
            selectionTableSection.style.display = 'block';
            initSelectionTableFromCurrent();
          }
          if (locationSection) locationSection.style.display = 'none';
          if (encodedSection) encodedSection.style.display = 'none';
          if (textEncodingSection) textEncodingSection.style.display = 'none';
          
          // Set encodings to None
          window.appState.categoryEncodedField = '';
          window.appState.categoryTextEncodedField = '';
          if (encodedSelect) encodedSelect.value = '';
          if (textEncodingSelect) textEncodingSelect.value = '';
          
        } else if (mode === 'feature') {
          // Hide selection table, show Location, Color Encoding, and Text Encoding
          if (selectionTableSection) selectionTableSection.style.display = 'none';
          if (locationSection) locationSection.style.display = 'block';
          if (encodedSection) {
            encodedSection.style.display = 'block';
            refreshEncodedColorDropdown();
          }
          if (textEncodingSection) {
            textEncodingSection.style.display = 'block';
            refreshTextEncodingDropdown();
          }
        }
        
        // Re-render if in Final View
        if (window.appState.viewMode === 'category-final' && window.appState.categorySelectedMetricKey && typeof window.renderBeeswarmCategoryFinal === 'function') {
          window.renderBeeswarmCategoryFinal(window.appState.categorySelectedMetricKey);
        }
      }

      window.refreshEncodedColorDropdown = refreshEncodedColorDropdown;
      window.refreshTextEncodingDropdown = refreshTextEncodingDropdown;
      window.updateEncodingMode = updateEncodingMode;
      refreshEncodedColorDropdown();
      refreshTextEncodingDropdown();
      showMultiSelectSection(window.appState.viewMode === 'category-v7');
      showFilterSelectSection(window.appState.viewMode === 'category-v8' || window.appState.viewMode === 'category-final');
      
      if (encodedSelect) {
        encodedSelect.addEventListener('change', function() {
          window.appState.categoryEncodedField = this.value;
          if (window.appState.viewMode === 'category-v6' && window.appState.categorySelectedMetricKey && typeof window.renderBeeswarmCategoryEncoded === 'function') {
            window.renderBeeswarmCategoryEncoded(window.appState.categorySelectedMetricKey);
          }
          if (window.appState.viewMode === 'category-final' && window.appState.categorySelectedMetricKey && typeof window.renderBeeswarmCategoryFinal === 'function') {
            window.renderBeeswarmCategoryFinal(window.appState.categorySelectedMetricKey);
          }
        });
      }
      
      if (textEncodingSelect) {
        textEncodingSelect.addEventListener('change', function() {
          window.appState.categoryTextEncodedField = this.value;
          if (window.appState.viewMode === 'category-final' && window.appState.categorySelectedMetricKey && typeof window.renderBeeswarmCategoryFinal === 'function') {
            window.renderBeeswarmCategoryFinal(window.appState.categorySelectedMetricKey);
          }
        });
      }
      
      // Encoding mode radio buttons
      document.querySelectorAll('input[name="encodingMode"]').forEach(radio => {
        radio.addEventListener('change', function() {
          if (this.checked) {
            updateEncodingMode(this.value);
          }
        });
      });
      
      // Initialize encoding mode (default to 'selection')
      if (!window.appState.encodingMode) {
        window.appState.encodingMode = 'selection';
      }

      if (filterSelectAddBtn) {
        filterSelectAddBtn.addEventListener('click', function() {
          if (typeof window.filterSelectAddFilter === 'function') {
            window.filterSelectAddFilter();
          }
        });
      }
      
      function toggleSidebar() {
        const isOpen = sidebar.classList.contains('open');
        if (isOpen) {
          sidebar.classList.remove('open');
          document.body.classList.remove('sidebar-open');
          arrow.textContent = '>';
        } else {
          sidebar.classList.add('open');
          document.body.classList.add('sidebar-open');
          arrow.textContent = '<';
        }
        
        // Re-render beeswarm after sidebar animation completes
        setTimeout(() => {
          const viewMode = window.appState.viewMode;
          console.log('Sidebar toggled, re-rendering view:', viewMode);
          if (viewMode === 'identifier') {
            const activeMetric = document.querySelector('.indicator-list .indicator-item.active');
            if (activeMetric && activeMetric.dataset.metricKey) {
              console.log('Re-rendering horizontal view:', activeMetric.dataset.metricKey);
              window.renderBeeswarm(activeMetric.dataset.metricKey);
            }
          } else if (viewMode === 'category' || viewMode === 'category-v2') {
            const activeMetric = document.querySelector('.indicator-list .category-label.active');
            console.log('Sidebar - Category view - activeMetric:', activeMetric);
            console.log('Sidebar - Category view - metricKey:', activeMetric?.dataset?.metricKey);
            console.log('Sidebar - Category view - renderFunction:', typeof window.renderBeeswarmCategory);
            if (activeMetric && activeMetric.dataset.metricKey && window.renderBeeswarmCategory) {
              console.log('Re-rendering category view:', activeMetric.dataset.metricKey);
              window.renderBeeswarmCategory(activeMetric.dataset.metricKey);
            } else {
              console.log('Sidebar - Category view - condition failed');
            }
          } else if (viewMode === 'category-v3') {
            const activeMetric = document.querySelector('.indicator-list .category-label.active');
            if (activeMetric && activeMetric.dataset.metricKey && window.renderBeeswarmCategoryV3) {
              console.log('Re-rendering category v3 view:', activeMetric.dataset.metricKey);
              window.renderBeeswarmCategoryV3(activeMetric.dataset.metricKey);
            }
          } else if (viewMode === 'category-v4') {
            if (window.appState.categorySelectedMetricKey) {
              console.log('Re-rendering category v4 view:', window.appState.categorySelectedMetricKey);
              renderBeeswarmCategoryV4(window.appState.categorySelectedMetricKey);
            }
          } else if (viewMode === 'category-v6') {
            const activeMetric = document.querySelector('.indicator-list .category-label.active');
            if (activeMetric && activeMetric.dataset.metricKey && typeof window.renderBeeswarmCategoryEncoded === 'function') {
              console.log('Re-rendering category v6 (encoded) view:', activeMetric.dataset.metricKey);
              window.renderBeeswarmCategoryEncoded(activeMetric.dataset.metricKey);
            }
          } else if (viewMode === 'category-final') {
            const activeMetric = document.querySelector('.indicator-list .category-label.active');
            if (activeMetric && activeMetric.dataset.metricKey && typeof window.renderBeeswarmCategoryFinal === 'function') {
              console.log('Re-rendering final view:', activeMetric.dataset.metricKey);
              window.renderBeeswarmCategoryFinal(activeMetric.dataset.metricKey);
            }
          } else if (viewMode === 'category-v7') {
            const activeMetric = document.querySelector('.indicator-list .category-label.active');
            if (activeMetric && activeMetric.dataset.metricKey && typeof window.renderBeeswarmCategoryMultiSelect === 'function') {
              console.log('Re-rendering category v7 (multi-select) view:', activeMetric.dataset.metricKey);
              window.renderBeeswarmCategoryMultiSelect(activeMetric.dataset.metricKey);
            }
          } else if (viewMode === 'category-v8') {
            const activeMetric = document.querySelector('.indicator-list .category-label.active');
            if (activeMetric && activeMetric.dataset.metricKey && typeof window.renderBeeswarmCategoryFilter === 'function') {
              console.log('Re-rendering category v8 (filter select) view:', activeMetric.dataset.metricKey);
              window.renderBeeswarmCategoryFilter(activeMetric.dataset.metricKey);
            }
          } else if (viewMode === 'category-v5') {
            const activeMetric = document.querySelector('.indicator-list .category-label.active');
            if (activeMetric && activeMetric.dataset.metricKey && window.renderBeeswarmCategoryComparison) {
              console.log('Re-rendering category v5 (comparison) view:', activeMetric.dataset.metricKey);
              window.renderBeeswarmCategoryComparison(activeMetric.dataset.metricKey);
            }
          } else if (viewMode === 'box') {
            const activeMetric = document.querySelector('.indicator-list .category-label.active');
            if (activeMetric && activeMetric.dataset.metricKey && window.renderBoxPlotCategory) {
              console.log('Re-rendering box plot view:', activeMetric.dataset.metricKey);
              window.renderBoxPlotCategory(activeMetric.dataset.metricKey);
            }
          }
        }, 400); // Wait for sidebar transition (300ms) + layout reflow buffer
      }
      
      sidebarToggle.addEventListener('click', toggleSidebar);
      
      // Sidebar tab switching
      document.querySelectorAll('.sidebar-tab').forEach(function(btn) {
        btn.addEventListener('click', function() {
          const tabId = this.dataset.tab;
          document.querySelectorAll('.sidebar-tab').forEach(function(b) { b.classList.remove('active'); });
          document.querySelectorAll('.tab-panel').forEach(function(p) { p.classList.remove('active'); });
          this.classList.add('active');
          const panel = document.getElementById(tabId + '-tab-panel');
          if (panel) panel.classList.add('active');

          // When switching to H-index tab, render all records with their H-index scores
          if (tabId === 'h-index' && typeof window.renderHIndex === 'function') {
            window.renderHIndex();
          }

          // When switching to Summation tab, render all records with their summation scores
          if (tabId === 'summation' && typeof window.renderSummation === 'function') {
            window.renderSummation();
          }

          // When switching to Outlier Data tab, render all records with outliers
          if (tabId === 'outlier-data' && typeof window.renderOutlierData === 'function') {
            window.renderOutlierData();
          }
        });
      });
      
      // State dropdown change event
      document.getElementById('stateSelect').addEventListener('change', function() {
        const selectedState = this.value;
        populateCountyDropdown(selectedState);

        if (window.appState.viewMode === 'category-v4') {
          // Set selectedCountry to first available county in this state
          const countySel = document.getElementById('countySelect');
          const countyVal = countySel && countySel.value ? countySel.value : '';
          if (selectedState && countyVal) {
            const display = `${countyVal}, ${selectedState}`;
            window.appState.selectedCountry = display;
            window.calculatePercentiles(window.appState.selectedCountry);
            window.updateCountryInfo();
          }
          if (window.appState.categorySelectedMetricKey) {
            renderBeeswarmCategoryV4(window.appState.categorySelectedMetricKey);
          }
          // Refresh metric list to reflect new percentiles
          if (window.renderCategoryMetricListV4) {
            window.renderCategoryMetricListV4();
          }
        }
      });
      
      // County dropdown change event
      document.getElementById('countySelect').addEventListener('change', function() {
        if (window.appState.viewMode === 'category-v4') {
          const stateSel = document.getElementById('stateSelect');
          const selectedState = stateSel ? stateSel.value : '';
          const selectedCounty = this.value;
          if (selectedState && selectedCounty) {
            const display = `${selectedCounty}, ${selectedState}`;
            window.appState.selectedCountry = display;
            window.calculatePercentiles(window.appState.selectedCountry);
            window.updateCountryInfo();
          }
          if (window.appState.categorySelectedMetricKey) {
            renderBeeswarmCategoryV4(window.appState.categorySelectedMetricKey);
          }
          if (window.renderCategoryMetricListV4) {
            window.renderCategoryMetricListV4();
          }
        }
      });
      
      // Dataset selection change event
      const datasetSelect = document.getElementById('dataset-select');
      if (datasetSelect) {
        datasetSelect.addEventListener('change', function() {
          const customUpload = document.getElementById('custom-upload');
          const isCustom = this.value === 'custom';
          if (customUpload) {
            customUpload.style.display = isCustom ? 'flex' : 'none';
          }
          
          if (isCustom) {
            return;
          }
          
          // Clear file input if switching away from custom
          const fileInput = document.getElementById('file-input');
          const fileName = document.getElementById('file-name');
          if (fileInput) fileInput.value = '';
          if (fileName) fileName.textContent = 'No file selected';
          
          // Load the selected dataset
          window.loadSelectedDataset();
          
          // If currently in V4 view, repopulate state dropdown
          if (window.appState.viewMode === 'category-v4') {
            populateStateDropdown();
          }
          showFilterSelectSection(window.appState.viewMode === 'category-v8' || window.appState.viewMode === 'category-final');
        });
      }
      
      // File input change event
      document.getElementById('file-input').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        // Truncate filename to 20 characters with ellipsis if longer
        const fileName = file.name.length > 20 ? file.name.substring(0, 20) + '...' : file.name;
        document.getElementById('file-name').textContent = fileName;
        
        // Show loading indicator
        document.querySelector('.loading').style.display = 'flex';
        
        // Read the file
        const reader = new FileReader();
        
        reader.onload = function(e) {
          try {
            // Parse the Excel file using a client-side library like SheetJS
            if (typeof XLSX !== 'undefined') {
              const data = new Uint8Array(e.target.result);
              const workbook = XLSX.read(data, { type: 'array' });
              
              // Get the first sheet
              const firstSheetName = workbook.SheetNames[0];
              const worksheet = workbook.Sheets[firstSheetName];
              
              // Convert to JSON
              window.appState.jsonData = XLSX.utils.sheet_to_json(worksheet);
              
              // Show column selection dialog
              showColumnSelectionDialog();
              
              // If currently in V4 view, repopulate state dropdown
              if (window.appState.viewMode === 'category-v4') {
                populateStateDropdown();
              }
            } else {
              // If XLSX library is not available, use the example data
              alert('XLSX library not loaded. Using example data instead.');
            }
          } catch (error) {
            console.error('Error parsing Excel file:', error);
            alert('Error parsing Excel file. Using example data instead.');
          }
          
          // Hide loading indicator
          document.querySelector('.loading').style.display = 'none';
        };
        
        reader.onerror = function() {
          console.error('Error reading file');
          alert('Error reading file. Using example data instead.');
          document.querySelector('.loading').style.display = 'none';
        };
        
        reader.readAsArrayBuffer(file);
      });
      
      // Country/County selection change event
      document.getElementById('countrySelect').addEventListener('change', function() {
        window.appState.selectedCountry = this.value;
        if (window.appState.selectedCountry) {
          window.calculatePercentiles(window.appState.selectedCountry);
          window.updateCountryInfo();
          
          // Get current step or default to 50
          const activeStep = document.querySelector('.step.is-active');
          const percentile = activeStep ? 
            parseInt(activeStep.getAttribute('data-step')) : 50;
          
          window.updateMetricsDisplay(percentile);
          
          // Populate all inline metrics in percentile scroll view
          if (window.appState.viewMode === 'percentile' && typeof window.populateAllInlineMetrics === 'function') {
            window.populateAllInlineMetrics();
          }

          // If in identifier/category view, refresh lists and active chart
          const activeMetricBtn = document.querySelector('.indicator-list .indicator-item.active');
          if (window.appState.viewMode === 'identifier') {
            window.renderIdentifierMetricList();
            const firstMetricBtn = document.querySelector('.indicator-list .indicator-item');
            if (firstMetricBtn && firstMetricBtn.dataset && firstMetricBtn.dataset.metricKey) {
              window.renderBeeswarm(firstMetricBtn.dataset.metricKey);
              firstMetricBtn.classList.add('active');
            }
          } else if (window.appState.viewMode === 'category') {
            window.renderCategoryMetricList();
            const firstMetricBtn = document.querySelector('.indicator-list .indicator-item');
            if (firstMetricBtn && firstMetricBtn.dataset && firstMetricBtn.dataset.metricKey) {
              window.renderBeeswarmCategory(firstMetricBtn.dataset.metricKey);
              firstMetricBtn.classList.add('active');
            }
          } else if (window.appState.viewMode === 'category-v2') {
            window.renderCategoryMetricListV2();
            const firstMetricBtn = document.querySelector('.indicator-list .indicator-item');
            if (firstMetricBtn && firstMetricBtn.dataset && firstMetricBtn.dataset.metricKey) {
              window.renderBeeswarmCategory(firstMetricBtn.dataset.metricKey);
              firstMetricBtn.classList.add('active');
            }
          } else if (window.appState.viewMode === 'category-v3') {
            window.renderCategoryMetricListV3();
            const firstMetricBtn = document.querySelector('.indicator-list .indicator-item');
            if (firstMetricBtn && firstMetricBtn.dataset && firstMetricBtn.dataset.metricKey) {
              window.renderBeeswarmCategoryV3(firstMetricBtn.dataset.metricKey);
              firstMetricBtn.classList.add('active');
            }
          } else if (window.appState.viewMode === 'category-v6') {
            if (typeof window.renderCategoryMetricListV6 === 'function') {
              window.renderCategoryMetricListV6();
            }
            const firstMetricBtn = document.querySelector('.indicator-list .category-label');
            if (firstMetricBtn && firstMetricBtn.dataset && firstMetricBtn.dataset.metricKey && typeof window.renderBeeswarmCategoryEncoded === 'function') {
              window.renderBeeswarmCategoryEncoded(firstMetricBtn.dataset.metricKey);
              firstMetricBtn.classList.add('active');
            }
          } else if (window.appState.viewMode === 'category-final') {
            if (typeof window.renderCategoryMetricListFinal === 'function') {
              window.renderCategoryMetricListFinal();
            }
            const firstMetricBtn = document.querySelector('.indicator-list .category-label');
            if (firstMetricBtn && firstMetricBtn.dataset && firstMetricBtn.dataset.metricKey && typeof window.renderBeeswarmCategoryFinal === 'function') {
              window.renderBeeswarmCategoryFinal(firstMetricBtn.dataset.metricKey);
              firstMetricBtn.classList.add('active');
            }
          } else if (window.appState.viewMode === 'category-v7') {
            if (typeof window.multiSelectSetPrimary === 'function') {
              window.multiSelectSetPrimary(window.appState.selectedCountry, { preserveOthers: false });
            }
            if (typeof window.renderCategoryMetricListV7 === 'function') {
              window.renderCategoryMetricListV7();
            }
            const firstMetricBtn = document.querySelector('.indicator-list .category-label');
            if (firstMetricBtn && firstMetricBtn.dataset && firstMetricBtn.dataset.metricKey && typeof window.renderBeeswarmCategoryMultiSelect === 'function') {
              window.renderBeeswarmCategoryMultiSelect(firstMetricBtn.dataset.metricKey);
              firstMetricBtn.classList.add('active');
            }
          } else if (window.appState.viewMode === 'category-v8') {
            if (typeof window.filterSelectEnsureState === 'function') {
              window.filterSelectEnsureState();
            }
            if (typeof window.renderCategoryMetricListV8 === 'function') {
              window.renderCategoryMetricListV8({ preserveSelection: true });
            }
          } else if (window.appState.viewMode === 'category-v4') {
            window.renderCategoryMetricListV4();
            const firstMetricBtn = document.querySelector('.indicator-list .category-label');
            if (firstMetricBtn && firstMetricBtn.dataset && firstMetricBtn.dataset.metricKey) {
              renderBeeswarmCategoryV4(firstMetricBtn.dataset.metricKey);
              firstMetricBtn.classList.add('active');
            }
          } else if (window.appState.viewMode === 'category-v5') {
            window.renderCategoryMetricListV5();
            const firstMetricBtn = document.querySelector('.indicator-list .category-label');
            if (firstMetricBtn && firstMetricBtn.dataset && firstMetricBtn.dataset.metricKey) {
              window.renderBeeswarmCategoryComparison(firstMetricBtn.dataset.metricKey);
              firstMetricBtn.classList.add('active');
            }
          } else if (window.appState.viewMode === 'box') {
            window.renderCategoryMetricListBox();
            const firstMetricBtn = document.querySelector('.indicator-list .indicator-item');
            if (firstMetricBtn && firstMetricBtn.dataset && firstMetricBtn.dataset.metricKey) {
              window.renderBoxPlotCategory(firstMetricBtn.dataset.metricKey);
              firstMetricBtn.classList.add('active');
            }
          }
          showMultiSelectSection(window.appState.viewMode === 'category-v7');
          showFilterSelectSection(window.appState.viewMode === 'category-v8' || window.appState.viewMode === 'category-final');
        } else {
          // No selection, reset display
          document.getElementById('country-name').textContent = window.appState.geoMode === 'country' ? 'Select a country' : 'Select a county';
          document.getElementById('metric-cards').innerHTML = 
            (window.appState.geoMode === 'country' 
              ? '<div class="no-metrics">Please select a country to view metrics</div>'
              : '<div class="no-metrics">Please select a county to view metrics</div>');
          showMultiSelectSection(false);
          showFilterSelectSection(window.appState.viewMode === 'category-v8' || window.appState.viewMode === 'category-final');
          
          // Re-render beeswarm to clear selection highlighting
          if (window.appState.viewMode === 'category-final' && window.appState.categorySelectedMetricKey) {
            if (typeof window.renderBeeswarmCategoryFinal === 'function') {
              window.renderBeeswarmCategoryFinal(window.appState.categorySelectedMetricKey);
            }
          }
        }
      });

      // Comparison country selection change event
      document.getElementById('comparisonCountrySelect').addEventListener('change', function() {
        window.appState.comparisonCountry = this.value;
        // Re-render the beeswarm and metrics list if in comparison view
        if (window.appState.viewMode === 'category-v5') {
          if (window.renderCategoryMetricListV5) {
            window.renderCategoryMetricListV5();
          }
          if (window.appState.categorySelectedMetricKey) {
            window.renderBeeswarmCategoryComparison(window.appState.categorySelectedMetricKey);
          }
        }
      });

      // Radio button event listeners for comparison view
      document.getElementById('selectMainLocation').addEventListener('change', function() {
        if (this.checked) {
          window.appState.activeLocationSelection = 'main';
        }
      });
      
      document.getElementById('selectComparisonLocation').addEventListener('change', function() {
        if (this.checked) {
          window.appState.activeLocationSelection = 'comparison';
        }
      });

      // View toggle event
      const viewToggle = document.getElementById('toggle-view');
      if (viewToggle) {
        viewToggle.addEventListener('change', function() {
          const pctContainer = document.getElementById('percentile-scroll-container');
          const idContainer = document.getElementById('country-identifier-container');
          
          // Cleanup Final View checkbox when switching away
          if (window.appState.viewMode === 'category-final' && this.value !== 'category-final') {
            if (typeof window.cleanupFinalViewBeeswarmCheckbox === 'function') {
              window.cleanupFinalViewBeeswarmCheckbox();
            }
          }
          
          window.appState.viewMode = this.value;
          
          // Show/hide location controls based on view mode
          const locationSection = document.getElementById('location-section');
          const comparisonLocationSection = document.getElementById('comparison-location-section');
          const stateSection = document.getElementById('state-section');
          const countySection = document.getElementById('county-section');
          
          if (this.value === 'category-v4') {
            locationSection.style.display = 'none';
            comparisonLocationSection.style.display = 'none';
            stateSection.style.display = 'block';
            countySection.style.display = 'block';
            // Populate state dropdown when switching to V4
            populateStateDropdown();
          } else if (this.value === 'category-v5') {
            locationSection.style.display = 'block';
            comparisonLocationSection.style.display = 'block';
            stateSection.style.display = 'none';
            countySection.style.display = 'none';
            // Show radio buttons for comparison view
            document.getElementById('selectMainLocation').style.display = 'inline-block';
            document.getElementById('selectComparisonLocation').style.display = 'inline-block';
            document.getElementById('selectMainLocation').checked = true;
            window.appState.activeLocationSelection = 'main';
            // Populate comparison dropdown when switching to V5
            populateComparisonDropdown();
          } else if (this.value === 'category-v8') {
            locationSection.style.display = 'none';
            comparisonLocationSection.style.display = 'none';
            stateSection.style.display = 'none';
            countySection.style.display = 'none';
            document.getElementById('selectMainLocation').style.display = 'none';
            if (document.getElementById('selectComparisonLocation')) {
              document.getElementById('selectComparisonLocation').style.display = 'none';
            }
          } else {
            locationSection.style.display = 'block';
            comparisonLocationSection.style.display = 'none';
            stateSection.style.display = 'none';
            countySection.style.display = 'none';
            // Hide radio buttons for non-comparison views
            document.getElementById('selectMainLocation').style.display = 'none';
            if (document.getElementById('selectComparisonLocation')) {
              document.getElementById('selectComparisonLocation').style.display = 'none';
            }
          }
          // Show/hide encoding mode section
          if (encodingModeSection) {
            if (this.value === 'category-final') {
              encodingModeSection.style.display = 'block';
              // Initialize or restore encoding mode
              const currentMode = window.appState.encodingMode || 'selection';
              const checkedRadio = document.querySelector(`input[name="encodingMode"][value="${currentMode}"]`);
              if (checkedRadio) checkedRadio.checked = true;
              updateEncodingMode(currentMode);
            } else {
              encodingModeSection.style.display = 'none';
            }
          }
          
          // For category-v6, show color encoding only
          if (encodedSection) {
            if (this.value === 'category-v6') {
              encodedSection.style.display = 'block';
              refreshEncodedColorDropdown();
            } else if (this.value !== 'category-final') {
              encodedSection.style.display = 'none';
            }
            // For category-final, visibility is controlled by encoding mode
          }
          
          // Text encoding only for Final View, controlled by encoding mode
          if (textEncodingSection && this.value !== 'category-final') {
            textEncodingSection.style.display = 'none';
          }
          
          showMultiSelectSection(this.value === 'category-v7');
          showFilterSelectSection(this.value === 'category-v8' || this.value === 'category-final');
          if (this.value === 'identifier') {
            pctContainer.classList.add('hidden');
            idContainer.classList.remove('hidden');
            // document.getElementById('app-title').textContent = 'Horizontal View'; // App title is hard-coded
            window.renderIdentifierMetricList();
            const firstMetricBtn = document.querySelector('.indicator-list .indicator-item');
            if (firstMetricBtn && firstMetricBtn.dataset && firstMetricBtn.dataset.metricKey) {
              window.renderBeeswarm(firstMetricBtn.dataset.metricKey);
              firstMetricBtn.classList.add('active');
            }
          } else if (this.value === 'category') {
            pctContainer.classList.add('hidden');
            idContainer.classList.remove('hidden');
            // document.getElementById('app-title').textContent = 'Category Slider (Distributed)'; // App title is hard-coded
            window.renderCategoryMetricList();
            const firstMetricBtn = document.querySelector('.indicator-list .indicator-item');
            if (firstMetricBtn && firstMetricBtn.dataset && firstMetricBtn.dataset.metricKey) {
              window.renderBeeswarmCategory(firstMetricBtn.dataset.metricKey);
              firstMetricBtn.classList.add('active');
            }
          } else if (this.value === 'category-v2') {
            pctContainer.classList.add('hidden');
            idContainer.classList.remove('hidden');
            // document.getElementById('app-title').textContent = 'Category Slider (Color ramp)'; // App title is hard-coded
            window.renderCategoryMetricListV2();
            const firstMetricBtn = document.querySelector('.indicator-list .indicator-item');
            if (firstMetricBtn && firstMetricBtn.dataset && firstMetricBtn.dataset.metricKey) {
              window.renderBeeswarmCategory(firstMetricBtn.dataset.metricKey);
              firstMetricBtn.classList.add('active');
            }
          } else if (this.value === 'category-v3') {
            pctContainer.classList.add('hidden');
            idContainer.classList.remove('hidden');
            // document.getElementById('app-title').textContent = 'Category Slider (Country Detailed)'; // App title is hard-coded
            window.renderCategoryMetricListV3();
            const firstMetricBtn = document.querySelector('.indicator-list .indicator-item');
            if (firstMetricBtn && firstMetricBtn.dataset && firstMetricBtn.dataset.metricKey) {
              window.renderBeeswarmCategoryV3(firstMetricBtn.dataset.metricKey);
              firstMetricBtn.classList.add('active');
            }
          } else if (this.value === 'category-v6') {
            pctContainer.classList.add('hidden');
            idContainer.classList.remove('hidden');
            // document.getElementById('app-title').textContent = 'Category Slider (Encoded Data)'; // App title is hard-coded
            if (typeof window.renderCategoryMetricListV6 === 'function') {
              window.renderCategoryMetricListV6();
            }
            const firstMetricBtn = document.querySelector('.indicator-list .category-label');
            if (firstMetricBtn && firstMetricBtn.dataset && firstMetricBtn.dataset.metricKey && typeof window.renderBeeswarmCategoryEncoded === 'function') {
              window.renderBeeswarmCategoryEncoded(firstMetricBtn.dataset.metricKey);
              firstMetricBtn.classList.add('active');
            }
          } else if (this.value === 'category-final') {
            pctContainer.classList.add('hidden');
            idContainer.classList.remove('hidden');
            // document.getElementById('app-title').textContent = 'Factxis'; // App title is hard-coded
            if (typeof window.renderCategoryMetricListFinal === 'function') {
              window.renderCategoryMetricListFinal();
            }
            const firstMetricBtn = document.querySelector('.indicator-list .category-label');
            if (firstMetricBtn && firstMetricBtn.dataset && firstMetricBtn.dataset.metricKey && typeof window.renderBeeswarmCategoryFinal === 'function') {
              window.renderBeeswarmCategoryFinal(firstMetricBtn.dataset.metricKey);
              firstMetricBtn.classList.add('active');
            }
          } else if (this.value === 'category-v7') {
            pctContainer.classList.add('hidden');
            idContainer.classList.remove('hidden');
            // document.getElementById('app-title').textContent = 'Category Slider (Multi-Select)'; // App title is hard-coded
            if (typeof window.multiSelectEnsureState === 'function') {
              window.multiSelectEnsureState();
            }
            if (typeof window.renderCategoryMetricListV7 === 'function') {
              window.renderCategoryMetricListV7();
            }
            const firstMetricBtn = document.querySelector('.indicator-list .category-label');
            if (firstMetricBtn && firstMetricBtn.dataset && firstMetricBtn.dataset.metricKey && typeof window.renderBeeswarmCategoryMultiSelect === 'function') {
              window.renderBeeswarmCategoryMultiSelect(firstMetricBtn.dataset.metricKey);
              firstMetricBtn.classList.add('active');
            }
          } else if (this.value === 'category-v8') {
            pctContainer.classList.add('hidden');
            idContainer.classList.remove('hidden');
            // document.getElementById('app-title').textContent = 'Filter Select'; // App title is hard-coded
            if (typeof window.filterSelectEnsureState === 'function') {
              window.filterSelectEnsureState();
            }
            if (typeof window.filterSelectRenderControls === 'function') {
              window.filterSelectRenderControls();
            }
            if (typeof window.renderCategoryMetricListV8 === 'function') {
              window.renderCategoryMetricListV8();
            }
            const firstMetricBtn = document.querySelector('.indicator-list .category-label');
            if (firstMetricBtn && firstMetricBtn.dataset && firstMetricBtn.dataset.metricKey && typeof window.renderBeeswarmCategoryFilter === 'function') {
              window.renderBeeswarmCategoryFilter(firstMetricBtn.dataset.metricKey);
              firstMetricBtn.classList.add('active');
            }
          } else if (this.value === 'category-v4') {
            pctContainer.classList.add('hidden');
            idContainer.classList.remove('hidden');
            // document.getElementById('app-title').textContent = 'Category Slider (County Detailed)'; // App title is hard-coded
            window.renderCategoryMetricListV4();
            const firstMetricBtn = document.querySelector('.indicator-list .category-label');
            if (firstMetricBtn && firstMetricBtn.dataset && firstMetricBtn.dataset.metricKey) {
              renderBeeswarmCategoryV4(firstMetricBtn.dataset.metricKey);
              firstMetricBtn.classList.add('active');
            }
          } else if (this.value === 'category-v5') {
            pctContainer.classList.add('hidden');
            idContainer.classList.remove('hidden');
            // document.getElementById('app-title').textContent = 'Category Slider (Comparison)'; // App title is hard-coded
            window.renderCategoryMetricListV5();
            const firstMetricBtn = document.querySelector('.indicator-list .category-label');
            if (firstMetricBtn && firstMetricBtn.dataset && firstMetricBtn.dataset.metricKey) {
              window.renderBeeswarmCategoryComparison(firstMetricBtn.dataset.metricKey);
              firstMetricBtn.classList.add('active');
            }
        } else if (this.value === 'box') {
          pctContainer.classList.add('hidden');
          idContainer.classList.remove('hidden');
          // document.getElementById('app-title').textContent = 'Box and Whisker View'; // App title is hard-coded
          window.renderCategoryMetricListBox();
          const firstMetricBtn = document.querySelector('.indicator-list .indicator-item');
          if (firstMetricBtn && firstMetricBtn.dataset && firstMetricBtn.dataset.metricKey) {
            window.renderBoxPlotCategory(firstMetricBtn.dataset.metricKey);
              firstMetricBtn.classList.add('active');
            }
          } else {
            idContainer.classList.add('hidden');
            pctContainer.classList.remove('hidden');
            // document.getElementById('app-title').textContent = 'Percentile Scroll'; // App title is hard-coded
            if (window.appState.scroller && typeof window.appState.scroller.resize === 'function') {
              window.appState.scroller.resize();
            }
          }
        });
      }
      
      // Add window resize listener to re-render beeswarm for all views
      let resizeTimeout;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          const viewMode = window.appState.viewMode;
          console.log('Window resized, re-rendering view:', viewMode);
          if (viewMode === 'identifier') {
            const activeMetric = document.querySelector('.indicator-list .indicator-item.active');
            if (activeMetric && activeMetric.dataset.metricKey) {
              console.log('Re-rendering horizontal view:', activeMetric.dataset.metricKey);
              window.renderBeeswarm(activeMetric.dataset.metricKey);
            }
          } else if (viewMode === 'category' || viewMode === 'category-v2') {
            const activeMetric = document.querySelector('.indicator-list .category-label.active');
            console.log('Resize - Category view - activeMetric:', activeMetric);
            console.log('Resize - Category view - metricKey:', activeMetric?.dataset?.metricKey);
            console.log('Resize - Category view - renderFunction:', typeof window.renderBeeswarmCategory);
            if (activeMetric && activeMetric.dataset.metricKey && window.renderBeeswarmCategory) {
              console.log('Re-rendering category view:', activeMetric.dataset.metricKey);
              window.renderBeeswarmCategory(activeMetric.dataset.metricKey);
            } else {
              console.log('Resize - Category view - condition failed');
            }
          } else if (viewMode === 'category-v3') {
            const activeMetric = document.querySelector('.indicator-list .category-label.active');
            if (activeMetric && activeMetric.dataset.metricKey && window.renderBeeswarmCategoryV3) {
              console.log('Re-rendering category v3 view:', activeMetric.dataset.metricKey);
              window.renderBeeswarmCategoryV3(activeMetric.dataset.metricKey);
            }
          } else if (viewMode === 'category-v4') {
            if (window.appState.categorySelectedMetricKey) {
              console.log('Re-rendering category v4 view:', window.appState.categorySelectedMetricKey);
              renderBeeswarmCategoryV4(window.appState.categorySelectedMetricKey);
            }
          } else if (viewMode === 'category-v6') {
            const activeMetric = document.querySelector('.indicator-list .category-label.active');
            if (activeMetric && activeMetric.dataset.metricKey && typeof window.renderBeeswarmCategoryEncoded === 'function') {
              console.log('Re-rendering category v6 (encoded) view:', activeMetric.dataset.metricKey);
              window.renderBeeswarmCategoryEncoded(activeMetric.dataset.metricKey);
            }
          } else if (viewMode === 'category-final') {
            const activeMetric = document.querySelector('.indicator-list .category-label.active');
            if (activeMetric && activeMetric.dataset.metricKey && typeof window.renderBeeswarmCategoryFinal === 'function') {
              console.log('Re-rendering final view:', activeMetric.dataset.metricKey);
              window.renderBeeswarmCategoryFinal(activeMetric.dataset.metricKey);
            }
          } else if (viewMode === 'category-v7') {
            const activeMetric = document.querySelector('.indicator-list .category-label.active');
            if (activeMetric && activeMetric.dataset.metricKey && typeof window.renderBeeswarmCategoryMultiSelect === 'function') {
              console.log('Re-rendering category v7 (multi-select) view:', activeMetric.dataset.metricKey);
              window.renderBeeswarmCategoryMultiSelect(activeMetric.dataset.metricKey);
            }
          } else if (viewMode === 'category-v5') {
            const activeMetric = document.querySelector('.indicator-list .category-label.active');
            if (activeMetric && activeMetric.dataset.metricKey && window.renderBeeswarmCategoryComparison) {
              console.log('Re-rendering category v5 (comparison) view:', activeMetric.dataset.metricKey);
              window.renderBeeswarmCategoryComparison(activeMetric.dataset.metricKey);
            }
          } else if (viewMode === 'box') {
            const activeMetric = document.querySelector('.indicator-list .category-label.active');
            if (activeMetric && activeMetric.dataset.metricKey && window.renderBoxPlotCategory) {
              console.log('Re-rendering box plot view:', activeMetric.dataset.metricKey);
              window.renderBoxPlotCategory(activeMetric.dataset.metricKey);
            }
          }
        }, 250); // Debounce resize events
      });
    }
    
      // Column Selection Dialog
      function showColumnSelectionDialog() {
        if (!window.appState.jsonData || window.appState.jsonData.length === 0) {
          window.processData();
          return;
        }
        
        const columns = Object.keys(window.appState.jsonData[0]);
        const dialog = document.getElementById('column-selection-dialog');
        const listContainer = document.getElementById('column-selection-list');
        const okBtn = document.getElementById('column-selection-ok');
        const cancelBtn = document.getElementById('column-selection-cancel');
        
        // Clear previous list
        listContainer.innerHTML = '';
        
        // Populate column list
        let selectedColumn = null;
        columns.forEach(column => {
          const item = document.createElement('div');
          item.className = 'column-list-item';
          item.textContent = column;
          item.dataset.column = column;
          
          // Single click to select
          item.addEventListener('click', function() {
            // Remove previous selection
            listContainer.querySelectorAll('.column-list-item').forEach(i => i.classList.remove('selected'));
            // Add selection to this item
            this.classList.add('selected');
            selectedColumn = this.dataset.column;
            okBtn.disabled = false;
          });
          
          // Double click to select and confirm
          item.addEventListener('dblclick', function() {
            selectedColumn = this.dataset.column;
            confirmColumnSelection(selectedColumn);
            dialog.style.display = 'none';
          });
          
          listContainer.appendChild(item);
        });
        
        // Disable OK button initially
        okBtn.disabled = true;
        
        // OK button handler
        okBtn.onclick = function() {
          if (selectedColumn) {
            confirmColumnSelection(selectedColumn);
            dialog.style.display = 'none';
          }
        };
        
        // Cancel button handler
        cancelBtn.onclick = function() {
          dialog.style.display = 'none';
          // Hide loading indicator
          document.querySelector('.loading').style.display = 'none';
        };
        
        // Show dialog
        dialog.style.display = 'flex';
      }
      
      function confirmColumnSelection(columnName) {
        // Store the selected column in appState
        window.appState.selectedDataColumn = columnName;
        
        // Process the data with the selected column
        // Show column selection dialog for custom datasets
        showColumnSelectionDialog();
        
        // Hide loading indicator
        document.querySelector('.loading').style.display = 'none';
      }

      // Column Selection Dialog Functions
      function showColumnSelectionDialog() {
        if (!window.appState.jsonData || window.appState.jsonData.length === 0) {
          window.processData();
          return;
        }
        
        const columns = Object.keys(window.appState.jsonData[0]);
        const dialog = document.getElementById('column-selection-dialog');
        const listContainer = document.getElementById('column-selection-list');
        const okBtn = document.getElementById('column-selection-ok');
        const cancelBtn = document.getElementById('column-selection-cancel');
        
        // Clear previous list
        listContainer.innerHTML = '';
        
        // Populate column list
        let selectedColumn = null;
        columns.forEach(column => {
          const item = document.createElement('div');
          item.className = 'column-list-item';
          item.textContent = column;
          item.dataset.column = column;
          
          // Single click to select
          item.addEventListener('click', function() {
            // Remove previous selection
            listContainer.querySelectorAll('.column-list-item').forEach(i => i.classList.remove('selected'));
            // Add selection to this item
            this.classList.add('selected');
            selectedColumn = this.dataset.column;
            okBtn.disabled = false;
          });
          
          // Double click to select and confirm
          item.addEventListener('dblclick', function() {
            selectedColumn = this.dataset.column;
            confirmColumnSelection(selectedColumn);
            dialog.style.display = 'none';
          });
          
          listContainer.appendChild(item);
        });
        
        // Disable OK button initially
        okBtn.disabled = true;
        
        // OK button handler
        okBtn.onclick = function() {
          if (selectedColumn) {
            confirmColumnSelection(selectedColumn);
            dialog.style.display = 'none';
          }
        };
        
        // Cancel button handler
        cancelBtn.onclick = function() {
          dialog.style.display = 'none';
          // Hide loading indicator
          document.querySelector('.loading').style.display = 'none';
        };
        
        // Show dialog
        dialog.style.display = 'flex';
      }
      
      function confirmColumnSelection(columnName) {
        // Store the selected column in appState
        window.appState.selectedDataColumn = columnName;
        
        // Process the data with the selected column
        window.processData();
        
        // Hide loading indicator
        document.querySelector('.loading').style.display = 'none';
      }

      // Make map popup resizable
    const mapPopup = document.getElementById('map-panel-popup');
    const mapPopupClose = document.getElementById('map-popup-close');
    
    if (mapPopup) {
      // Close button functionality
      if (mapPopupClose) {
        mapPopupClose.addEventListener('click', function() {
          mapPopup.style.display = 'none';
          window.appState.finalViewMapMode = false;
          const mapCheckbox = document.getElementById('map-mode-checkbox');
          if (mapCheckbox) mapCheckbox.checked = false;
        });
      }
      
      // Add resize handle
      const resizeHandle = document.createElement('div');
      resizeHandle.className = 'map-resize-handle';
      mapPopup.appendChild(resizeHandle);
      
      // Resize functionality
      let isResizing = false;
      let startWidth = 0;
      let startHeight = 0;
      let startX = 0;
      let startY = 0;
      
      resizeHandle.addEventListener('mousedown', function(e) {
        isResizing = true;
        startWidth = mapPopup.offsetWidth;
        startHeight = mapPopup.offsetHeight;
        startX = e.clientX;
        startY = e.clientY;
        e.preventDefault();
      });
      
      document.addEventListener('mousemove', function(e) {
        if (!isResizing) return;
        e.preventDefault();
        
        const deltaX = startX - e.clientX;
        const deltaY = e.clientY - startY;
        
        const newWidth = Math.max(250, startWidth + deltaX);
        const newHeight = Math.max(200, startHeight + deltaY);
        
        mapPopup.style.width = newWidth + 'px';
        mapPopup.style.height = newHeight + 'px';
        
        // Update SVG size
        const svg = document.getElementById('map-svg');
        if (svg) {
          const headerHeight = 30;
          const padding = 20;
          svg.setAttribute('width', newWidth - padding);
          svg.setAttribute('height', newHeight - headerHeight - padding);
          // Re-render map with new size
          if (typeof window.renderMapPanel === 'function') {
            window.renderMapPanel();
          }
        }
      });
      
      document.addEventListener('mouseup', function() {
        isResizing = false;
      });
    }
  </script>
</body>
</html>

